<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>BLS Rhythm Trainer – アンパンマンのマーチ v2.5 (14sec sync + 正規化スコア修正版)</title>
<style>
body{margin:0;background:#faefdb;font-family:"Segoe UI","Rounded Mplus 1c",sans-serif;text-align:center;overflow:hidden}
h2{margin-top:10px;color:#d85b7b}
canvas{background:#faefdb;border-radius:8px;margin-top:10px}
.controls{margin:10px 0}
#judge{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);
font-size:48px;font-weight:bold;color:white;text-shadow:0 0 10px black;
opacity:0;transition:opacity .3s ease;pointer-events:none}
#resultPanel{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
background:rgba(255,246,236,.9);border:3px solid #f5a3a3;border-radius:16px;
padding:24px 48px;text-align:center;color:#d85b7b;font-weight:bold;font-size:26px;
opacity:0;transition:opacity 1s ease;pointer-events:none;box-shadow:0 0 12px rgba(255,200,200,.5)}
#countdown{position:absolute;top:38%;left:50%;transform:translate(-50%,-50%);
font-size:96px;font-weight:800;color:#d85b7b;text-shadow:0 4px 16px rgba(216,91,123,.35);
opacity:0;transition:opacity .2s ease;pointer-events:none}
#hint{font-size:13px;color:#666;margin-top:6px}
</style>
</head>
<body>
<h2>💖 BLS Rhythm Trainer – アンパンマンのマーチ (v2.5・14秒到達＋スコア正規化修正版)</h2>
<div class="controls">
<button id="start">▶ 開始</button>
<button id="stop">■ 停止</button>
<button id="reset">↻ リセット</button>
<span id="sound" style="font-size:13px;color:#444;">🔇 音未確認</span>
</div>
<div style="position:relative;display:inline-block">
<canvas id="game" width="1000" height="600"></canvas>
<div id="judge">Perfect!</div>
<div id="resultPanel"></div>
<div id="countdown">3</div>
</div>
<p id="hint">
外部端末で「アンパンマンのマーチ」を再生してください。<br>
カウントダウン「GO!」と同時に曲を流し、<br>
<b>GOから14秒後</b>に最初のノーツが判定円に到達します。<br>
（1番終了＝約1分10秒）
</p>

<script>
(()=>{const W=1000,H=600,canvas=document.getElementById("game"),ctx=canvas.getContext("2d"),
judgeEl=document.getElementById("judge"),resultPanel=document.getElementById("resultPanel"),
countdownEl=document.getElementById("countdown");
const mannequin=new Image();
mannequin.src="./AA3BFA6F-7DB2-44A5-BED7-E7BC31A224EF.png";
let imgReady=false;mannequin.onload=()=>imgReady=true;
const mouthY=.32*H,chestY=.61*H,hitX=190;
let AC,clickBuf,running=false;
async function ensureAudio(){if(!AC)AC=new (window.AudioContext||window.webkitAudioContext)();
await AC.resume();if(!clickBuf){const len=AC.sampleRate*.04;clickBuf=AC.createBuffer(1,len,AC.sampleRate);
const d=clickBuf.getChannelData(0);for(let i=0;i<len;i++)d[i]=Math.sin(2*Math.PI*1000*i/AC.sampleRate)*Math.exp(-i/(len/8));}
document.getElementById("sound").textContent="🔊 音OK";}
function click(){if(!AC||!clickBuf)return;const s=AC.createBufferSource();s.buffer=clickBuf;s.connect(AC.destination);s.start();}
let perfect=0,good=0,miss=0;
function flashJudge(t,c){judgeEl.textContent=t;judgeEl.style.color=c;judgeEl.style.opacity=1;setTimeout(()=>judgeEl.style.opacity=0,500);}
function spawnHeart(x,y){hearts.push({x,y,vy:-1,alpha:1})}let hearts=[];
function spawnFlash(x,y,c){flashes.push({x,y,life:1,color:c})}let flashes=[];
const bpm=96.05,spb=60/bpm,lead=4*spb,ARRIVE_AT=14,appearDelay=ARRIVE_AT-lead,STOP_AT=71;
let chartTemplate=[];(function(){let t=0;const hold=1*spb,cycles=6;
for(let c=0;c<cycles;c++){for(let i=0;i<30;i++){chartTemplate.push({type:"comp",offset:t,y:chestY});t+=spb;}
chartTemplate.push({type:"breath",offset:t,hold:hold,y:mouthY});t+=hold+spb;
chartTemplate.push({type:"breath",offset:t,hold:hold,y:mouthY});t+=hold+spb;}})();
let chart=[];const HIT={perfect:.1,good:.18};let holdActive=null;
function judgeTapForComp(y,time){for(const n of chart){if(n.hit||n.type!=="comp"||Math.abs(n.y-y)>6)continue;
const diff=Math.abs(time-n.time);if(diff<HIT.perfect){n.hit="perfect";return"perfect"}
if(diff<HIT.good){n.hit="good";return"good"}}return"miss"}
function tryStartHold(y,time){for(const n of chart){if(n.hit||n.type!=="breath"||Math.abs(n.y-y)>6)continue;
if(Math.abs(time-n.time)<HIT.good){holdActive={note:n,startTime:time};return"start"}}return"fail"}
function finishHold(time){if(!holdActive)return"miss";const n=holdActive.note;
if(n.hit){holdActive=null;return"miss"}const held=time-holdActive.startTime,expect=n.hold||0,err=Math.abs(held-expect);
let res;res=err<=.15?"perfect":err<=.3?"good":"miss";n.hit=res;holdActive=null;return res}
canvas.addEventListener("pointerdown",async e=>{await ensureAudio();click();if(!running)return;
const rect=canvas.getBoundingClientRect(),y=(e.clientY-rect.top)*(H/rect.height);
const lane=Math.abs(y-mouthY)<40?mouthY:Math.abs(y-chestY)<40?chestY:null;if(!lane)return;
const t=AC.currentTime;if(lane===chestY){const r=judgeTapForComp(lane,t);
if(r==="perfect"){perfect++;flashJudge("Perfect!","#ff8ccf");spawnHeart(hitX,lane-20);spawnFlash(hitX,lane,"#ffbcd9")}
else if(r==="good"){good++;flashJudge("Good!","#ffd93b");spawnFlash(hitX,lane,"#fff3a3")}
else{miss++;flashJudge("Miss!","#ff4b4b")}}
else{const s=tryStartHold(lane,t);
if(s==="start")spawnFlash(hitX,lane,"#cfe4ff");else{miss++;flashJudge("Miss!","#ff4b4b")}}});
canvas.addEventListener("pointerup",e=>{if(!running)return;const t=AC.currentTime;
if(holdActive){const r=finishHold(t);if(r==="perfect"){perfect++;flashJudge("Perfect!","#8cdcff");
spawnHeart(hitX,holdActive?.note?.y?holdActive.note.y-20:mouthY-20)}
else if(r==="good"){good++;flashJudge("Good!","#ffd93b")}else{miss++;flashJudge("Miss!","#ff4b4b")}}});
function draw(now){ctx.clearRect(0,0,W,H);ctx.fillStyle="#faefdb";ctx.fillRect(0,0,W,H);
if(imgReady){const ratio=mannequin.width/mannequin.height,targetH=H,targetW=targetH*ratio;
ctx.drawImage(mannequin,0,0,targetW,targetH)}
ctx.fillStyle="rgba(150,180,255,0.25)";ctx.fillRect(0,mouthY-20,W,40);
ctx.fillStyle="rgba(255,180,180,0.25)";ctx.fillRect(0,chestY-20,W,40);
ctx.lineWidth=4;ctx.strokeStyle="#1877ff";ctx.beginPath();ctx.arc(hitX,mouthY,30,0,2*Math.PI);ctx.stroke();
ctx.strokeStyle="#ff4b4b";ctx.beginPath();ctx.arc(hitX,chestY,35,0,2*Math.PI);ctx.stroke();
const right=W-40,speed=(right-hitX)/lead;
for(const n of chart){const x=hitX+(n.time-now)*speed;if(x<-140||x>W+140)continue;
if(n.type==="comp"){ctx.fillStyle="#ff4b4b";ctx.beginPath();ctx.arc(x,n.y,20,0,2*Math.PI);ctx.fill()}
else{const xE=hitX+(n.time+n.hold-now)*speed;ctx.fillStyle="#1877ff";
ctx.fillRect(Math.min(x,xE),n.y-10,Math.abs(xE-x),20);
ctx.beginPath();ctx.arc(x,n.y,10,0,2*Math.PI);ctx.fill();
ctx.beginPath();ctx.arc(xE,n.y,10,0,2*Math.PI);ctx.fill()}}
for(const h of hearts){ctx.globalAlpha=h.alpha;ctx.fillStyle="#ff8ccf";
ctx.beginPath();ctx.moveTo(h.x,h.y);ctx.bezierCurveTo(h.x-6,h.y-8,h.x-14,h.y+2,h.x,h.y+12);
ctx.bezierCurveTo(h.x+14,h.y+2,h.x+6,h.y-8,h.x,h.y);ctx.fill();ctx.globalAlpha=1}
for(const f of flashes){ctx.globalAlpha=f.life;ctx.fillStyle=f.color;
ctx.beginPath();ctx.arc(f.x,f.y,25*(1-f.life),0,2*Math.PI);ctx.fill();ctx.globalAlpha=1}
for(const h of hearts){h.y+=h.vy;h.alpha-=.02}for(const f of flashes){f.life-=.05}
hearts=hearts.filter(h=>h.alpha>0);flashes=flashes.filter(f=>f.life>0)}
let goTime=null;
function loop(){const now=AC?AC.currentTime:performance.now()/1e3;draw(now);
if(running&&goTime){if(now>=goTime+STOP_AT||chart.every(n=>n.hit)){running=false;showResult();return}}
if(running)requestAnimationFrame(loop)}

// ✅ 修正版：スコア計算のみ正規化
function showResult() {
  const hittable = chart.filter(n => n.type === "comp" || n.type === "breath").length;
  const total = perfect + good + miss;
  const score = Math.round(((perfect * 100) + (good * 70)) / Math.max(total, 1));
  resultPanel.innerHTML = `💖 SCORE ${score}点！<br>Perfect: ${perfect}　Good: ${good}　Miss: ${miss}`;
  resultPanel.style.opacity = 1;
}

function runCountdown(onGo){const seq=["3","2","1","GO!"];let i=0;
countdownEl.style.opacity=1;countdownEl.textContent=seq[i++];const timer=setInterval(()=>{
if(i<seq.length)countdownEl.textContent=seq[i++];else{clearInterval(timer);
setTimeout(()=>countdownEl.style.opacity=0,600);onGo()}},1e3)}
document.getElementById("start").onclick=async()=>{await ensureAudio();click();
perfect=good=miss=0;resultPanel.style.opacity=0;running=true;
runCountdown(()=>{goTime=AC.currentTime;const startBase=goTime+appearDelay;
chart=chartTemplate.map(n=>({...n,time:startBase+n.offset,hold:n.hold||0,hit:false}));
loop()})};
document.getElementById("stop").onclick=()=>{running=false;showResult()};
document.getElementById("reset").onclick=()=>window.location.reload();
})();
</script>
</body>
</html>
