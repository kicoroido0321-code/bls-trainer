<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BLS Rhythm Trainer â€“ ã‚¢ãƒ³ãƒ‘ãƒ³ãƒãƒ³ã®ãƒãƒ¼ãƒ v1.7 (GO+3s / å³ç«¯å‡ºç¾)</title>
<style>
  body{margin:0;background:#faefdb;font-family:"Segoe UI","Rounded Mplus 1c",sans-serif;text-align:center;overflow:hidden;}
  h2{margin-top:10px;color:#d85b7b}
  canvas{background:#faefdb;border-radius:8px;margin-top:10px}
  .controls{margin:10px 0}
  #judge{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);
    font-size:48px;font-weight:800;color:#fff;text-shadow:0 0 10px #0008;opacity:0;transition:opacity .3s;pointer-events:none}
  #result{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    background:rgba(255,246,236,.95);border:3px solid #f5a3a3;border-radius:16px;padding:22px 40px;
    color:#d85b7b;font-weight:700;font-size:24px;box-shadow:0 0 12px rgba(255,200,200,.5);opacity:0;transition:opacity .8s}
  #count{position:absolute;top:38%;left:50%;transform:translate(-50%,-50%);
    font-size:96px;font-weight:900;color:#d85b7b;text-shadow:0 6px 18px rgba(216,91,123,.35);opacity:0;transition:opacity .2s}
  #hint{font-size:13px;color:#666;margin:6px 0 10px}
</style>
</head>
<body>
<h2>ğŸ’– BLS Rhythm Trainer â€“ ã‚¢ãƒ³ãƒ‘ãƒ³ãƒãƒ³ã®ãƒãƒ¼ãƒï¼ˆv1.7ï¼‰</h2>

<div class="controls">
  <button id="start">â–¶ é–‹å§‹</button>
  <button id="stop">â–  åœæ­¢</button>
  <button id="reset">â†» ãƒªã‚»ãƒƒãƒˆ</button>
  <span id="sound" style="font-size:13px;color:#444">ğŸ”‡ éŸ³æœªç¢ºèª</span>
</div>

<div style="position:relative;display:inline-block;">
  <canvas id="game" width="1000" height="600"></canvas>
  <div id="judge">Perfect!</div>
  <div id="result"></div>
  <div id="count">3</div>
</div>

<p id="hint">
èµ¤ï¼èƒ¸éª¨åœ§è¿«ï¼ˆå˜ç™ºï¼‰ï¼é’ï¼äººå·¥å‘¼å¸ï¼ˆé•·æŠ¼ã—2æ‹ï¼‰<br>
å³â†’å·¦ã«æµã‚Œã¾ã™ã€‚å·¦ã®ãƒãƒã‚­ãƒ³ã®å£ãƒ»èƒ¸ã®å††ãŒåˆ¤å®šãƒ©ã‚¤ãƒ³ã€‚<br>
<b>ã€ŒGO!ã€ã®3ç§’å¾Œã«æœ€åˆã®èµ¤ãƒãƒ¼ãƒ„ãŒåˆ¤å®šå††ã«åˆ°é”</b>ã—ã¾ã™ã€‚
</p>

<script>
(()=>{

// ===== Canvas / layout =====
const W=1000,H=600;
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');

const hitX=190;                 // åˆ¤å®šå††X
const mouthY=H*0.32, chestY=H*0.61;
const spawnX=W+120;             // å³ç«¯ã®æ›´ã«å¤–å´ã‹ã‚‰å‡ºã™ï¼ˆç¢ºå®Ÿã«å³ç«¯å‡ºç¾ï¼‰

// èƒŒæ™¯ãƒãƒã‚­ãƒ³
const mannequin=new Image();
mannequin.src='./AA3BFA6F-7DB2-44A5-BED7-E7BC31A224EF.png';
let imgReady=false; mannequin.onload=()=>imgReady=true;

// ===== Audio (click) =====
let AC, clickBuf, running=false, goTime=null;
async function ensureAudio(){
  if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)();
  await AC.resume();
  if(!clickBuf){
    const len=AC.sampleRate*0.04;
    clickBuf=AC.createBuffer(1,len,AC.sampleRate);
    const d=clickBuf.getChannelData(0);
    for(let i=0;i<len;i++){
      d[i]=Math.sin(2*Math.PI*1000*i/AC.sampleRate)*Math.exp(-i/(len/8));
    }
  }
  document.getElementById('sound').textContent='ğŸ”Š éŸ³OK';
}
function click(){const s=AC.createBufferSource(); s.buffer=clickBuf; s.connect(AC.destination); s.start();}

// ===== Score / UI =====
const judgeEl=document.getElementById('judge');
const resultEl=document.getElementById('result');
const countEl=document.getElementById('count');
let perfect=0,good=0,miss=0;

function showJudge(t,c){judgeEl.textContent=t;judgeEl.style.color=c;judgeEl.style.opacity=1;setTimeout(()=>judgeEl.style.opacity=0,500);}

// ===== Chart =====
// ãƒ†ãƒ³ãƒã¯ 96.05 BPM
const BPM=96.05;
const SPB=60/BPM;

// 30:2ï¼ˆåœ§è¿«30æ‹ â†’ å‘¼å¸Ã—2ï¼ˆå„1.2æ‹ãƒ›ãƒ¼ãƒ«ãƒ‰ï¼‹0.7æ‹é–“ï¼‰ï¼‰ã‚’ç¹°ã‚Šè¿”ã—
let chartTemplate=[];
(function build(){
  const hold=1.2*SPB;
  let t=0;
  const cycles=5; // 1ç•ªåˆ†ã®ååˆ†ãªé•·ã•ï¼ˆå¿…è¦ãªã‚‰å¢—æ¸›OKï¼‰
  for(let c=0;c<cycles;c++){
    for(let i=0;i<30;i++){ chartTemplate.push({type:'comp',offset:t,y:chestY}); t+=SPB; }
    chartTemplate.push({type:'breath',offset:t+0.7*SPB,hold:hold,y:mouthY}); t+=1.2*SPB+0.7*SPB;
    chartTemplate.push({type:'breath',offset:t+0.7*SPB,hold:hold,y:mouthY}); t+=1.2*SPB+0.7*SPB;
  }
})();

let chart=[]; // å®Ÿæ™‚é–“ã«å±•é–‹å¾Œã®è­œé¢
const HIT={perfect:0.10, good:0.18}; // è¨±å®¹èª¤å·®ï¼ˆç§’ï¼‰

function judgeTap(y,time){
  for(const n of chart){
    if(n.hit || Math.abs(n.y-y)>6) continue;
    const diff=Math.abs(time-n.time);
    if(diff<HIT.perfect){ n.hit='perfect'; return 'perfect'; }
    if(diff<HIT.good){ n.hit='good'; return 'good'; }
  }
  return 'miss';
}

canvas.addEventListener('pointerdown', async e=>{
  await ensureAudio(); click();
  if(!running) return;
  const r=canvas.getBoundingClientRect();
  const y=(e.clientY-r.top)*(H/r.height);
  const lane = Math.abs(y-mouthY)<40 ? mouthY : (Math.abs(y-chestY)<40 ? chestY : null);
  if(lane==null) return;
  const t=AC.currentTime;
  const res=judgeTap(lane,t);
  if(res==='perfect'){ perfect++; showJudge('Perfect!','#ff8ccf'); }
  else if(res==='good'){ good++; showJudge('Good!','#ffd93b'); }
  else { miss++; showJudge('Miss!','#ff4b4b'); }
});

// ===== Drawing =====
function draw(now){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#faefdb'; ctx.fillRect(0,0,W,H);

  if(imgReady){
    const ratio=mannequin.width/mannequin.height;
    const th=H, tw=th*ratio;
    ctx.drawImage(mannequin,0,0,tw,th);
  }

  // ãƒ¬ãƒ¼ãƒ³
  ctx.fillStyle='rgba(150,180,255,0.25)'; ctx.fillRect(0,mouthY-20,W,40);
  ctx.fillStyle='rgba(255,180,180,0.25)'; ctx.fillRect(0,chestY-20,W,40);

  // åˆ¤å®šå††
  ctx.lineWidth=4;
  ctx.strokeStyle='#1877ff'; ctx.beginPath(); ctx.arc(hitX,mouthY,30,0,Math.PI*2); ctx.stroke();
  ctx.strokeStyle='#ff4b4b'; ctx.beginPath(); ctx.arc(hitX,chestY,35,0,Math.PI*2); ctx.stroke();

  // å³â†’å·¦ ä½ç½®è¨ˆç®—ï¼ˆspawnX ã‹ã‚‰ hitX ã¾ã§ NOTE_TRAVEL ç§’ï¼‰
  const NOTE_TRAVEL = 3.0;                         // â˜… æœ€åˆã®åˆ°é”åŸºæº–ã«ã‚‚ä½¿ã†
  const speed = (spawnX - hitX) / NOTE_TRAVEL;     // px / s

  for(const n of chart){
    const travel = now - n.time;                   // åˆ°é”åŸºæº–æ™‚åˆ»ã‹ã‚‰ã®çµŒé
    const x = spawnX - travel*speed;               // å³â†’å·¦

    if(x < -140 || x > spawnX+20) continue;        // ç”»é¢å¤–ã¯æã‹ãªã„

    if(n.type==='comp'){
      ctx.fillStyle='#ff4b4b';
      ctx.beginPath(); ctx.arc(x,n.y,20,0,Math.PI*2); ctx.fill();
    }else{
      const xHold = spawnX - (now - (n.time + n.hold))*speed;
      ctx.fillStyle='#1877ff';
      ctx.fillRect(Math.min(x,xHold), n.y-10, Math.abs(xHold-x), 20);
      ctx.beginPath(); ctx.arc(x,n.y,10,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(xHold,n.y,10,0,Math.PI*2); ctx.fill();
    }
  }
}

function loop(){
  const now = AC ? AC.currentTime : performance.now()/1000;
  draw(now);

  if(running){
    // ã™ã¹ã¦ã®ãƒãƒ¼ãƒ„ãŒå‡¦ç†æ¸ˆã¿ + å°‘ã—ä½™éŸ»ã‚’æŒã£ã¦çµ‚äº†
    if(now > lastNoteTime + 2.0){ running=false; showResult(); return; }
    requestAnimationFrame(loop);
  }
}

function showResult(){
  const total = chart.length;
  const score = Math.round((perfect*3 + good*1) / (total*3) * 100);
  resultEl.innerHTML = `ğŸ’– SCORE ${score}ç‚¹ï¼<br>Perfect: ${perfect}ã€€Good: ${good}ã€€Miss: ${miss}`;
  resultEl.style.opacity = 1;
}

// ===== Start / Countdown =====
let lastNoteTime = 0;

function countdown(onGo){
  const seq=['3','2','1','GO!']; let i=0;
  countEl.style.opacity=1; countEl.textContent=seq[i++];
  const timer=setInterval(()=>{
    if(i<seq.length){ countEl.textContent=seq[i++]; }
    else{ clearInterval(timer); setTimeout(()=>countEl.style.opacity=0,500); onGo(); }
  },1000);
}

document.getElementById('start').onclick=async()=>{
  await ensureAudio(); click();
  perfect=good=miss=0; resultEl.style.opacity=0; running=true;

  countdown(()=>{
    goTime = AC.currentTime;

    // â˜… æœ€åˆã®ãƒãƒ¼ãƒ„ã‚’ã€ŒGO+3ç§’ã€ã§åˆ¤å®šå††åˆ°é”ã«ã™ã‚‹ï¼šå‡ºç¾ãƒ™ãƒ¼ã‚¹æ™‚åˆ»
    const ARRIVE_FIRST = 3.0;                     // GOã‹ã‚‰åˆ°é”ã¾ã§
    const NOTE_TRAVEL  = 3.0;                     // æç”»å´ã¨åŒã˜
    const appearDelay  = ARRIVE_FIRST - NOTE_TRAVEL;   // å‡ºç¾é–‹å§‹ã¾ã§ã®é…å»¶
    const startBase    = goTime + appearDelay;         // ã“ã“ã« template ã® offset ã‚’è¶³ã™

    chart = chartTemplate.map(n=>({
      ...n,
      time: startBase + n.offset,                 // åˆ¤å®šåŸºæº–æ™‚åˆ»
      hold: n.hold||0,
      y: n.y,
      hit: false
    }));

    // ãƒ©ã‚¹ãƒˆãƒãƒ¼ãƒ„ã®æ™‚åˆ»ï¼ˆåˆ¤å®šç”¨ï¼‰
    lastNoteTime = chart.reduce((mx,n)=>Math.max(mx, n.time + (n.hold||0)), 0);

    loop();
  });
};

document.getElementById('stop').onclick=()=>{ running=false; showResult(); };
document.getElementById('reset').onclick=()=>window.location.reload();

})();
</script>
</body>
</html>
