<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BLS Rhythm Trainer â€“ Paprika v2.1 Synchronized Hold (BPM103)</title>
<style>
  body {
    margin: 0;
    background-color: #faefdb;
    font-family: "Segoe UI","Rounded Mplus 1c",sans-serif;
    text-align: center;
    overflow: hidden;
  }
  h2 { margin-top:10px; color:#d85b7b; }
  canvas { background-color:#faefdb; border-radius:8px; margin-top:10px; }
  .controls { margin:10px 0; }
  #judge {
    position:absolute; top:45%; left:50%; transform:translate(-50%,-50%);
    font-size:48px; font-weight:bold; color:white;
    text-shadow:0 0 10px black; opacity:0; transition:opacity .3s ease;
    pointer-events:none;
  }
  #resultPanel {
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background:rgba(255,246,236,0.9); border:3px solid #f5a3a3;
    border-radius:16px; padding:24px 48px; text-align:center;
    color:#d85b7b; font-weight:bold; font-size:26px;
    opacity:0; transition:opacity 1s ease; pointer-events:none;
    box-shadow: 0 0 12px rgba(255,200,200,0.5);
  }
  #countdown {
    position:absolute; top:38%; left:50%; transform:translate(-50%,-50%);
    font-size:96px; font-weight:800; color:#d85b7b;
    text-shadow:0 4px 16px rgba(216,91,123,0.35);
    opacity:0; transition:opacity .2s ease; pointer-events:none;
  }
  #hint { font-size:13px; color:#666; margin-top:6px; }
</style>
</head>
<body>
<h2>ğŸ’– BLS Rhythm Trainer â€“ Paprika (Synchronized Hold v2.1 / BPM103)</h2>

<div class="controls">
  <button id="start">â–¶ é–‹å§‹</button>
  <button id="stop">â–  åœæ­¢</button>
  <button id="reset">â†» ãƒªã‚»ãƒƒãƒˆ</button>
  <span id="sound" style="font-size:13px;color:#444;">ğŸ”‡ éŸ³æœªç¢ºèª</span>
</div>

<div style="position:relative;display:inline-block;">
  <canvas id="game" width="1000" height="600"></canvas>
  <div id="judge">Perfect!</div>
  <div id="resultPanel"></div>
  <div id="countdown">3</div>
</div>

<p id="hint">
å¤–éƒ¨ç«¯æœ«ã§ã€Œãƒ‘ãƒ—ãƒªã‚«ã€ã‚’å†ç”Ÿã—ã¦ãã ã•ã„ã€‚<br>
ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã€ŒGO!ã€ã¨åŒæ™‚ã«æ›²ã‚’æµã—ã€<br>
<b>GOã‹ã‚‰12ç§’å¾Œ</b>ã«æœ€åˆã®ãƒãƒ¼ãƒ„ãŒåˆ¤å®šå††ã«åˆ°é”ã—ã¾ã™ã€‚<br>
ï¼ˆ1ç•ªçµ‚äº†ï¼1åˆ†11ç§’ã§ã‚²ãƒ¼ãƒ çµ‚äº†ï¼‰
</p>

<script>
(() => {
const W=1000,H=600;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const judgeEl=document.getElementById("judge");
const resultPanel=document.getElementById("resultPanel");
const countdownEl=document.getElementById("countdown");

const mannequin=new Image();
// ã‚ãªãŸã®ç”»åƒåã«åˆã‚ã›ã¦ãã ã•ã„ï¼ˆãã®ã¾ã¾ã§ã‚‚OKï¼‰
mannequin.src="./AA3BFA6F-7DB2-44A5-BED7-E7BC31A224EF.png";
let imgReady=false; mannequin.onload=()=>imgReady=true;

const mouthY=H*0.32, chestY=H*0.61, hitX=190;

let AC, clickBuf, running=false;
async function ensureAudio(){
  if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)();
  await AC.resume();
  if(!clickBuf){
    const len=AC.sampleRate*0.04;
    clickBuf=AC.createBuffer(1,len,AC.sampleRate);
    const d=clickBuf.getChannelData(0);
    for(let i=0;i<len;i++)
      d[i]=Math.sin(2*Math.PI*1000*i/AC.sampleRate)*Math.exp(-i/(len/8));
  }
  document.getElementById("sound").textContent="ğŸ”Š éŸ³OK";
}
function click(){
  if(!AC||!clickBuf) return;
  const s=AC.createBufferSource();
  s.buffer=clickBuf;
  s.connect(AC.destination);
  s.start();
}

let perfect=0,good=0,miss=0;
function flashJudge(text,color){
  judgeEl.textContent=text;
  judgeEl.style.color=color;
  judgeEl.style.opacity=1;
  setTimeout(()=>judgeEl.style.opacity=0,500);
}
function spawnHeart(x,y){hearts.push({x,y,vy:-1,alpha:1});}
let hearts=[];
function spawnFlash(x,y,color){flashes.push({x,y,life:1,color});}
let flashes=[];

// ===== Paprika BPM103 ï¼‹ ä¿å­˜ç‰ˆã®æµé€Ÿ =====
const bpm=103;
const spb=60/bpm;           // 1æ‹ â‰’ 0.583s
const lead=4*spb;           // â‰’ 2.33sï¼ˆä¿å­˜ç‰ˆã¨åŒç­‰ã®è¦‹ãˆæ–¹ï¼‰
const ARRIVE_AT=12.0;       // GOâ†’12sã§æœ€åˆã®ç€å¼¾
const appearDelay=ARRIVE_AT - lead; // â‰’ 9.67sã§ãƒãƒ¼ãƒ„å‡ºç¾é–‹å§‹
const STOP_AT=71.0;         // 1:11ã§çµ‚äº†

// ===== è­œé¢ï¼šåœ§è¿«30ï¼ˆèµ¤ï¼‰â†’ å‘¼å¸2ï¼ˆé’ï¼š1æ‹ãƒ›ãƒ¼ãƒ«ãƒ‰ï¼‰ã‚’6ã‚µã‚¤ã‚¯ãƒ« =====
let chartTemplate=[];
(function build(){
  let t=0;
  const hold=1.0*spb; // å‘¼å¸ã¯1æ‹é•·æŠ¼ã—
  const cycles=6;
  for(let c=0;c<cycles;c++){
    for(let i=0;i<30;i++){
      chartTemplate.push({type:"comp",offset:t,y:chestY});
      t+=spb; // 1æ‹ã”ã¨
    }
    // å‘¼å¸1å›ç›®ï¼ˆèµ¤ã®ç›´å¾Œã«åŒæ‹ã§å…¥ã‚Šï¼‰
    chartTemplate.push({type:"breath",offset:t,hold:hold,y:mouthY});
    t += hold + spb; // 1æ‹æŠ¼ã—ã¦1æ‹ç©ºã‘ã‚‹ï¼ˆä½“æ„Ÿã«ä½™è£•ï¼‰
    // å‘¼å¸2å›ç›®
    chartTemplate.push({type:"breath",offset:t,hold:hold,y:mouthY});
    t += hold + spb; // æ¬¡ã‚µã‚¤ã‚¯ãƒ«ã¸
  }
})();

let chart=[];
const HIT={ // é–‹å§‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨±å®¹ï¼ˆç§’ï¼‰
  perfect:0.10,
  good:0.18
};

// é•·æŠ¼ã—ç”¨ã®å…¥åŠ›çŠ¶æ…‹
let holdActive=null; // {note, startTime}

// åˆ¤å®šï¼ˆåœ§è¿«ï¼šã‚¿ãƒƒãƒ—æ™‚ï¼å‘¼å¸ï¼šæŠ¼ã—çµ‚äº†æ™‚ï¼‰
function judgeTapForComp(y,time){
  for(const n of chart){
    if(n.hit || n.type!=="comp" || Math.abs(n.y-y)>6) continue;
    const diff=Math.abs(time - n.time);
    if(diff<HIT.perfect){ n.hit="perfect"; return "perfect"; }
    if(diff<HIT.good){ n.hit="good"; return "good"; }
  }
  return "miss";
}
// å‘¼å¸ã®é–‹å§‹ï¼ˆé–‹å§‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã ã‘ãƒã‚§ãƒƒã‚¯ã—ã¦äºˆç´„ï¼‰
function tryStartHold(y,time){
  for(const n of chart){
    if(n.hit || n.type!=="breath" || Math.abs(n.y-y)>6) continue;
    const diffStart = time - n.time; // é…ã‚Œæ­£æ–¹å‘
    if(Math.abs(diffStart) < HIT.good){
      // é–‹å§‹ã¯OKã€çµ‚äº†ã§æœ€çµ‚åˆ¤å®š
      holdActive = {note:n, startTime:time};
      return "start";
    }
  }
  return "fail";
}
// å‘¼å¸ã®çµ‚äº†ï¼ˆæŠ¼ã—ã¦ã„ãŸé•·ã•ã§åˆ¤å®šï¼‰
function finishHold(time){
  if(!holdActive) return "miss";
  const n = holdActive.note;
  if(n.hit){ holdActive=null; return "miss"; }
  const held = time - holdActive.startTime;
  const expect = n.hold || 0;
  const err = Math.abs(held - expect);
  let res;
  if(err <= 0.15){ res="perfect"; }
  else if(err <= 0.30){ res="good"; }
  else { res="miss"; }
  n.hit = res;
  holdActive = null;
  return res;
}

canvas.addEventListener("pointerdown", async e=>{
  await ensureAudio(); click();
  if(!running) return;
  const rect=canvas.getBoundingClientRect();
  const y=(e.clientY-rect.top)*(H/rect.height);
  const lane = (Math.abs(y-mouthY)<40)? mouthY : (Math.abs(y-chestY)<40? chestY : null);
  if(!lane) return;

  const t=AC.currentTime;

  if(lane===chestY){
    // åœ§è¿«ï¼šå˜ç™º
    const r=judgeTapForComp(lane,t);
    if(r==="perfect"){ perfect++; flashJudge("Perfect!","#ff8ccf"); spawnHeart(hitX,lane-20); spawnFlash(hitX,lane,"#ffbcd9"); }
    else if(r==="good"){ good++; flashJudge("Good!","#ffd93b"); spawnFlash(hitX,lane,"#fff3a3"); }
    else { miss++; flashJudge("Miss!","#ff4b4b"); }
  }else{
    // å‘¼å¸ï¼šé•·æŠ¼ã—é–‹å§‹ã‚’è©¦ã¿ã‚‹
    const s=tryStartHold(lane,t);
    if(s==="start"){
      // è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ï¼ˆé–‹å§‹æ™‚ã«è»½ãï¼‰
      spawnFlash(hitX,lane,"#cfe4ff");
    }else{
      miss++; flashJudge("Miss!","#ff4b4b");
    }
  }
});

canvas.addEventListener("pointerup", e=>{
  if(!running) return;
  const t=AC.currentTime;
  if(holdActive){
    const r=finishHold(t);
    if(r==="perfect"){ perfect++; flashJudge("Perfect!","#8cdcff"); spawnHeart(hitX,holdActive?.note?.y? holdActive.note.y-20 : mouthY-20); }
    else if(r==="good"){ good++; flashJudge("Good!","#ffd93b"); }
    else { miss++; flashJudge("Miss!","#ff4b4b"); }
  }
});

function draw(now){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="#faefdb"; ctx.fillRect(0,0,W,H);

  if(imgReady){
    const ratio=mannequin.width/mannequin.height;
    const targetH=H, targetW=targetH*ratio;
    ctx.drawImage(mannequin,0,0,targetW,targetH);
  }

  // ãƒ¬ãƒ¼ãƒ³å¸¯
  ctx.fillStyle="rgba(150,180,255,0.25)";
  ctx.fillRect(0,mouthY-20,W,40);
  ctx.fillStyle="rgba(255,180,180,0.25)";
  ctx.fillRect(0,chestY-20,W,40);

  // åˆ¤å®šå††
  ctx.lineWidth=4;
  ctx.strokeStyle="#1877ff"; ctx.beginPath(); ctx.arc(hitX,mouthY,30,0,Math.PI*2); ctx.stroke();
  ctx.strokeStyle="#ff4b4b"; ctx.beginPath(); ctx.arc(hitX,chestY,35,0,Math.PI*2); ctx.stroke();

  // ãƒãƒ¼ãƒ„æç”»
  const right=W-40;
  const speed=(right-hitX)/lead; // ä¿å­˜ç‰ˆã®è¦‹ãˆæ–¹

  for(const n of chart){
    const x=hitX + (n.time - now)*speed;
    if(x<-140 || x>W+140) continue;

    if(n.type==="comp"){
      ctx.fillStyle="#ff4b4b";
      ctx.beginPath(); ctx.arc(x,n.y,20,0,Math.PI*2); ctx.fill();
    }else{
      const xE=hitX + (n.time + n.hold - now)*speed;
      ctx.fillStyle="#1877ff";
      ctx.fillRect(Math.min(x,xE), n.y-10, Math.abs(xE-x), 20);
      // ã‚­ãƒ£ãƒƒãƒ—
      ctx.beginPath(); ctx.arc(x, n.y, 10, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(xE, n.y, 10, 0, Math.PI*2); ctx.fill();
    }
  }

  // æ¼”å‡º
  for(const h of hearts){
    ctx.globalAlpha=h.alpha; ctx.fillStyle="#ff8ccf";
    ctx.beginPath();
    ctx.moveTo(h.x,h.y);
    ctx.bezierCurveTo(h.x-6,h.y-8,h.x-14,h.y+2,h.x,h.y+12);
    ctx.bezierCurveTo(h.x+14,h.y+2,h.x+6,h.y-8,h.x,h.y);
    ctx.fill(); ctx.globalAlpha=1;
  }
  for(const f of flashes){
    ctx.globalAlpha=f.life; ctx.fillStyle=f.color;
    ctx.beginPath(); ctx.arc(f.x,f.y,25*(1-f.life),0,Math.PI*2);
    ctx.fill(); ctx.globalAlpha=1;
  }
  for(const h of hearts){ h.y+=h.vy; h.alpha-=0.02; }
  for(const f of flashes){ f.life-=0.05; }
  hearts=hearts.filter(h=>h.alpha>0);
  flashes=flashes.filter(f=>f.life>0);
}

let goTime=null;

function loop(){
  const now=AC?AC.currentTime:performance.now()/1000;
  draw(now);
  if(running&&goTime){
    if(now >= goTime + STOP_AT || chart.every(n=>n.hit)){
      running=false; showResult(); return;
    }
  }
  if(running) requestAnimationFrame(loop);
}

function showResult(){
  const total=chart.length;
  const score=Math.round((perfect*3+good*1)/(total*3)*100);
  resultPanel.innerHTML=`ğŸ’– SCORE ${score}ç‚¹ï¼<br>Perfect: ${perfect}ã€€Good: ${good}ã€€Miss: ${miss}`;
  resultPanel.style.opacity=1;
}

function runCountdown(onGo){
  const seq=["3","2","1","GO!"];
  let i=0; countdownEl.style.opacity=1; countdownEl.textContent=seq[i++];
  const timer=setInterval(()=>{
    if(i<seq.length){countdownEl.textContent=seq[i++];}
    else{
      clearInterval(timer);
      setTimeout(()=>{countdownEl.style.opacity=0;},600);
      onGo();
    }
  },1000);
}

document.getElementById("start").onclick=async()=>{
  await ensureAudio(); click();
  perfect=good=miss=0; resultPanel.style.opacity=0;
  running=true;
  runCountdown(()=>{
    goTime=AC.currentTime;
    const startBase=goTime + appearDelay; // GOâ†’ç´„9.67sã§å‡ºç¾é–‹å§‹ï¼ˆâ†’12såˆ°é”ï¼‰
    chart = chartTemplate.map(n=>({
      ...n,
      time: startBase + n.offset,
      hold: n.hold||0,
      y: n.y,
      type: n.type,
      hit: false
    }));
    loop();
  });
};
document.getElementById("stop").onclick=()=>{ running=false; showResult(); };
document.getElementById("reset").onclick=()=>window.location.reload();

})();
</script>
</body>
</html>
