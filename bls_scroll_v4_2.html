<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLS Rhythm Trainer â€“ Adult 30:2</title>
<style>
  body {
    text-align: center;
    font-family: 'Segoe UI', sans-serif;
    background-color: #f4f6fa;
  }
  canvas {
    background-color: #fff;
    margin-top: 10px;
    border-radius: 8px;
  }
  .control {
    margin: 10px;
  }
</style>
</head>
<body>
<h2>ğŸ’— BLS Rhythm Trainer â€“ Adult 30:2</h2>
<div class="control">
  BPM <input type="number" id="bpm" value="110" style="width:60px;"> å›ºå®š
  <button id="start">â–¶ï¸é–‹å§‹</button>
  <button id="stop">â¹åœæ­¢</button>
  <button id="reset">ğŸ”„ãƒªã‚»ãƒƒãƒˆ</button>
  <span id="sound">ğŸ”ŠéŸ³OK</span>
</div>
<canvas id="game" width="1000" height="600"></canvas>
<p style="font-size:13px; color:#555;">
èµ¤ï¼èƒ¸éª¨åœ§è¿«ï¼ˆå˜ç™ºï¼‰ï¼é’ï¼äººå·¥å‘¼å¸ï¼ˆé•·æŠ¼ã—2æ‹ï¼‰ã€‚<br>
å³â†’å·¦ã«æµã‚Œã€å·¦ã®ãƒãƒã‚­ãƒ³ã®å£ãƒ»èƒ¸ã®å††ãŒåˆ¤å®šãƒ©ã‚¤ãƒ³ã§ã™ã€‚<br>
éŸ³ãŒå‡ºãªã„ã¨ãã¯æœ€åˆã«ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„ã€‚
</p>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = 1000, H = 600;
  canvas.width = W; canvas.height = H;

  // ==== èƒŒæ™¯ãƒãƒã‚­ãƒ³ ====
  const mannequin = new Image();
  mannequin.src = "./AA3BFA6F-7DB2-44A5-BED7-E7BC31A224EF.png"; // â† ã‚¢ãƒƒãƒ—ã—ãŸç”»åƒ
  let mannequinReady = false;
  mannequin.onload = () => mannequinReady = true;

  // ==== åˆ¤å®šãƒ©ã‚¤ãƒ³åº§æ¨™ ====
  const mouthY = 160;
  const chestY = 330;
  const lineX = 180;

  // ==== ãƒãƒ¼ãƒ„ ====
  const notes = [];
  const bpm = 110;
  const interval = (60 / bpm) * 1000;
  const longNoteLen = 120; // å‘¼å¸ãƒãƒ¼ãƒ„ã®é•·ã•

  for (let i = 0; i < 30; i++) {
    notes.push({ x: W + i * 100, y: chestY, type: 'red', len: 0 });
  }
  // äººå·¥å‘¼å¸ãƒãƒ¼ãƒ„ï¼ˆé–“éš”ã‚’å°‘ã—ç©ºã‘ã‚‹ï¼‰
  notes.push({ x: W + 3200, y: mouthY, type: 'blue', len: longNoteLen });
  notes.push({ x: W + 3400, y: mouthY, type: 'blue', len: longNoteLen });

  let startTime = null, running = false;
  let AC, clickBuf;

  async function ensureAudio() {
    if (!AC) AC = new (window.AudioContext || window.webkitAudioContext)();
    await AC.resume();
    if (!clickBuf) {
      const o = AC.createOscillator();
      const g = AC.createGain();
      o.connect(g).connect(AC.destination);
      o.type = "square";
      o.frequency.value = 1000;
      o.start();
      o.stop(AC.currentTime + 0.05);
    }
  }

  // ==== åˆ¤å®š ====
  let score = { perfect: 0, good: 0, miss: 0 };
  function judge(note, diff) {
    if (diff < 50) score.perfect++;
    else if (diff < 120) score.good++;
    else score.miss++;
  }

  // ==== ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ====
  function update() {
    ctx.clearRect(0, 0, W, H);
    if (mannequinReady) ctx.drawImage(mannequin, 0, 0, 300, 600);

    // åˆ¤å®šå††
    ctx.lineWidth = 3;
    ctx.strokeStyle = "#aaa";
    ctx.beginPath(); ctx.arc(lineX, mouthY, 30, 0, Math.PI * 2); ctx.stroke();
    ctx.beginPath(); ctx.arc(lineX, chestY, 35, 0, Math.PI * 2); ctx.stroke();

    const now = Date.now();
    notes.forEach(n => {
      n.x -= 4; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦
      ctx.fillStyle = n.type === 'red' ? '#f44' : '#3af';
      ctx.beginPath(); ctx.arc(n.x, n.y, 20, 0, Math.PI * 2); ctx.fill();
    });

    ctx.fillStyle = "#333";
    ctx.font = "16px sans-serif";
    ctx.fillText(`Perfect ${score.perfect} / Good ${score.good} / Miss ${score.miss}`, 420, 30);

    if (running) requestAnimationFrame(update);
  }

  document.getElementById('start').onclick = async () => {
    await ensureAudio();
    running = true;
    score = { perfect: 0, good: 0, miss: 0 };
    startTime = Date.now();
    update();
  };
  document.getElementById('stop').onclick = () => running = false;
  document.getElementById('reset').onclick = () => window.location.reload();
})();
</script>
</body>
</html>
